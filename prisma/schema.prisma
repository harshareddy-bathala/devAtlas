// Prisma Schema for DevOrbit
// Database: PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  name            String?
  avatarUrl       String?   @map("avatar_url")
  provider        String    @default("email") // email, github, google
  providerId      String?   @map("provider_id")
  role            UserRole  @default(USER)
  theme           Theme     @default(DARK)
  
  // Preferences (stored as JSON for flexibility)
  preferences     Json      @default("{}")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")
  
  // Relations
  skills          Skill[]
  projects        Project[]
  resources       Resource[]
  activities      Activity[]
  timeEntries     TimeEntry[]
  tags            Tag[]
  sessions        Session[]
  
  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

enum UserRole {
  USER
  ADMIN
}

enum Theme {
  DARK
  LIGHT
  SYSTEM
}

// ============================================
// CORE ENTITIES
// ============================================

model Skill {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  name        String
  category    SkillCategory @default(LANGUAGE)
  status      SkillStatus @default(WANT_TO_LEARN)
  icon        String      @default("ðŸ“š")
  notes       String?
  priority    Int         @default(0)
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  resources   Resource[]
  activities  Activity[]
  timeEntries TimeEntry[]
  tags        SkillTag[]
  
  @@unique([userId, name])
  @@index([userId])
  @@index([status])
  @@index([category])
  @@map("skills")
}

enum SkillCategory {
  LANGUAGE
  FRAMEWORK
  LIBRARY
  TOOL
  DATABASE
  RUNTIME
  CLOUD
  DEVOPS
  OTHER
}

enum SkillStatus {
  WANT_TO_LEARN
  LEARNING
  MASTERED
}

model Project {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  name        String
  description String?
  status      ProjectStatus @default(IDEA)
  priority    Int           @default(0)
  
  // Links
  githubUrl   String?       @map("github_url")
  demoUrl     String?       @map("demo_url")
  techStack   String[]      @default([])
  
  // GitHub Integration
  githubRepoId    String?   @map("github_repo_id")
  githubRepoName  String?   @map("github_repo_name")
  
  // Dates
  startedAt   DateTime?     @map("started_at")
  completedAt DateTime?     @map("completed_at")
  dueDate     DateTime?     @map("due_date")
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  resources   Resource[]
  activities  Activity[]
  timeEntries TimeEntry[]
  tags        ProjectTag[]
  
  @@unique([userId, name])
  @@index([userId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  IDEA
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

model Resource {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  title       String
  url         String
  type        ResourceType  @default(ARTICLE)
  notes       String?
  isRead      Boolean       @default(false) @map("is_read")
  isFavorite  Boolean       @default(false) @map("is_favorite")
  rating      Int?
  
  // Optional relations to skill/project
  skillId     String?       @map("skill_id")
  projectId   String?       @map("project_id")
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill       Skill?        @relation(fields: [skillId], references: [id], onDelete: SetNull)
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  tags        ResourceTag[]
  
  @@index([userId])
  @@index([skillId])
  @@index([projectId])
  @@index([type])
  @@map("resources")
}

enum ResourceType {
  DOCUMENTATION
  VIDEO
  COURSE
  ARTICLE
  TUTORIAL
  BOOK
  PODCAST
  TOOL
  OTHER
}

model Activity {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  date        DateTime      @db.Date
  type        ActivityType
  description String?
  
  // Optional relations
  skillId     String?       @map("skill_id")
  projectId   String?       @map("project_id")
  
  // Metadata
  durationMinutes Int?      @map("duration_minutes")
  metadata    Json?
  
  createdAt   DateTime      @default(now()) @map("created_at")
  
  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill       Skill?        @relation(fields: [skillId], references: [id], onDelete: SetNull)
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([date])
  @@index([type])
  @@index([skillId])
  @@index([projectId])
  @@map("activities")
}

enum ActivityType {
  LEARNING
  CODING
  READING
  PROJECT
  REVIEW
  PRACTICE
  OTHER
}

// ============================================
// TIME TRACKING
// ============================================

model TimeEntry {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  
  // What was worked on
  description String?
  skillId     String?     @map("skill_id")
  projectId   String?     @map("project_id")
  
  // Time data
  startTime   DateTime    @map("start_time")
  endTime     DateTime?   @map("end_time")
  durationSeconds Int?    @map("duration_seconds")
  
  // Timer state
  isRunning   Boolean     @default(false) @map("is_running")
  
  // Metadata
  notes       String?
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill       Skill?      @relation(fields: [skillId], references: [id], onDelete: SetNull)
  project     Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  tags        TimeEntryTag[]
  
  @@index([userId])
  @@index([startTime])
  @@index([skillId])
  @@index([projectId])
  @@index([isRunning])
  @@map("time_entries")
}

// ============================================
// TAGS SYSTEM (Many-to-Many)
// ============================================

model Tag {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  name        String
  color       String      @default("#8b5cf6")
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills      SkillTag[]
  projects    ProjectTag[]
  resources   ResourceTag[]
  timeEntries TimeEntryTag[]
  
  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

// Junction tables for many-to-many relations
model SkillTag {
  skillId     String      @map("skill_id")
  tagId       String      @map("tag_id")
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  
  skill       Skill       @relation(fields: [skillId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([skillId, tagId])
  @@map("skill_tags")
}

model ProjectTag {
  projectId   String      @map("project_id")
  tagId       String      @map("tag_id")
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([projectId, tagId])
  @@map("project_tags")
}

model ResourceTag {
  resourceId  String      @map("resource_id")
  tagId       String      @map("tag_id")
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  
  resource    Resource    @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([resourceId, tagId])
  @@map("resource_tags")
}

model TimeEntryTag {
  timeEntryId String      @map("time_entry_id")
  tagId       String      @map("tag_id")
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  
  timeEntry   TimeEntry   @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([timeEntryId, tagId])
  @@map("time_entry_tags")
}
